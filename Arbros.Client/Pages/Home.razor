@page "/"
@inject HttpClient Http
@using Arbros.Shared.Models
@using Microsoft.AspNetCore.Components

<h3>Agregar Tarea</h3>
<input @bind="nuevaTarea" placeholder="Ingrese una tarea" />
<SfButton CssClass="e-primary" @onclick="AgregarTarea">Agregar Tarea</SfButton>

@* INICIO DE LA TABLA *@

<SfGrid DataSource="tiempo">
    <GridColumns>
        <GridColumn Field="@nameof(Tiempo.Tareas)" HeaderText="Tarea" />
        <GridColumn Field="@nameof(Tiempo.FechaCreacion)" HeaderText="Fecha de Creación" Format="yyyy-MM-dd HH:mm:ss" />
        <GridColumn Field="@nameof(Tiempo.HoraInicio)" HeaderText="Inicio de Trabajo" Format="yyyy-MM-dd HH:mm:ss" />
        <GridColumn Field="@nameof(Tiempo.HoraFin)" HeaderText="Fin de Trabajo" Format="yyyy-MM-dd HH:mm:ss" />
        <GridColumn HeaderText="Acciones">
            <Template Context="tiempoItem">
                <SfButton CssClass="e-primary"
                          @onclick="() => IniciarTrabajo((Tiempo)tiempoItem)"
                          Disabled="@IsIniciarButtonDisabled((Tiempo)tiempoItem)">
                    Iniciar
                </SfButton>
                <SfButton CssClass="e-danger"
                          @onclick="() => RegistrarFinalizacionTrabajo((Tiempo)tiempoItem)"
                          Disabled="@IsFinalizarButtonDisabled((Tiempo)tiempoItem)">
                    Finalizar
                </SfButton>
            </Template>
        </GridColumn>
    </GridColumns>
</SfGrid>

@* FINAL DE LA TABLA *@

@code {
    public List<Tiempo> tiempo = new List<Tiempo>();
    private string? nuevaTarea;
    private HashSet<int> trabajosIniciados = new HashSet<int>();
    private HashSet<int> trabajosFinalizados = new HashSet<int>();

    // Carga las tareas al inicializar el componente
    protected override async Task OnInitializedAsync()
    {
        await CargarTareas();
    }

    private async Task AgregarTarea()
    {
        if (!string.IsNullOrWhiteSpace(nuevaTarea))
        {
            var nuevaEntrada = new Tiempo
                {
                    Tareas = nuevaTarea,
                    FechaCreacion = DateTime.Now,
                    HoraInicio = null,
                    HoraFin = null
                };

            var response = await Http.PostAsJsonAsync("api/Tiempo", nuevaEntrada);
            if (response.IsSuccessStatusCode)
            {
                await CargarTareas(); // Recarga la lista de tareas
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error: {response.StatusCode}, {errorContent}");
            }

            nuevaTarea = string.Empty; // Limpia el campo de entrada
        }
    }

    // Carga la lista de tareas
    private async Task CargarTareas()
    {
        var response = await Http.GetFromJsonAsync<List<Tiempo>>("api/Tiempo");
        if (response != null)
        {
            tiempo = response; // Actualiza la lista de tareas
            StateHasChanged(); // Notifica a Blazor que debe volver a renderizar
        }
    }

    // Registra el inicio de un trabajo
    private async Task IniciarTrabajo(Tiempo trabajo)
    {
        trabajo.HoraInicio = DateTime.Now; // Establece HoraInicio al momento actual
        var response = await Http.PostAsJsonAsync("api/Tiempo/IniciarTrabajo", trabajo);
        if (response.IsSuccessStatusCode)
        {
            trabajosIniciados.Add(trabajo.Id);
            await CargarTareas();
        }
    }

    // Registra la finalización de un trabajo
    private async Task RegistrarFinalizacionTrabajo(Tiempo trabajo)
    {
        var response = await Http.PostAsync($"api/Tiempo/FinalizarTrabajo/{trabajo.Id}", null);
        if (response.IsSuccessStatusCode)
        {
            trabajosFinalizados.Add(trabajo.Id);
            await CargarTareas();
        }
    }

    // Método para verificar si el botón "Iniciar" debe estar deshabilitado
    private bool IsIniciarButtonDisabled(Tiempo trabajo)
    {
        return trabajosIniciados.Contains(trabajo.Id) || trabajo.HoraInicio != null;
    }

    // Método para verificar si el botón "Finalizar" debe estar deshabilitado
    private bool IsFinalizarButtonDisabled(Tiempo trabajo)
    {
        return trabajosFinalizados.Contains(trabajo.Id) || trabajo.HoraFin != null;
    }
}







